name: å¤‡ä»½äºŒè¿›åˆ¶ç¨‹åº

on:
  workflow_dispatch:
  schedule:
    - cron:  '0 4 */3 * *'

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - name: æ‹‰å–ä»£ç 
      uses: actions/checkout@v4

    - name: åˆ›å»ºå‘è¡Œç‰ˆ
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        
        # èµ‹äºˆè„šæœ¬æƒé™
        chmod 755 ./scripts/binary/*
        # åˆ›å»ºäºŒè¿›åˆ¶åŒ…æ–‡ä»¶ç›®å½•
        mkdir ~/dist_binary
        
        # éå†ç›®å½•ä¸‹æ‰€æœ‰çš„ .sh æ–‡ä»¶å¹¶æ‰§è¡Œ
        for SCRIPT in ./scripts/binary/*.sh; do
          if [ -f "$SCRIPT" ]; then
            echo "æ‰§è¡Œ $SCRIPT è„šæœ¬"
            bash "$SCRIPT"
          else
            echo "æ²¡æœ‰è„šæœ¬æ–‡ä»¶"
          fi
        done
        
        script_num=`ls -1 ./scripts/binary | wc -l`
        binary_num=`ls -1 ~/dist_binary | wc -l`
        
        # æ£€æŸ¥ä¸¤ä¸ªå˜é‡æ˜¯å¦éƒ½å¤§äº 0 å¹¶ä¸”ç›¸ç­‰
        if [ "$script_num" -gt 0 ] && [ "$binary_num" -gt 0 ] && [ "$script_num" -eq "$binary_num" ]; then
          # åˆ é™¤æ ‡ç­¾å¹¶æ¨é€
          gh release delete v1.0.0 -y || true
          git tag -d v1.0.0 || true
          git push origin --delete v1.0.0 || true
          
          # æ‰“æ ‡ç­¾å¹¶æ¨é€
          git tag v1.0.0
          git push origin v1.0.0
          gh release create v1.0.0 ~/dist_binary/* --title "v1.0.0" --notes "ğŸ”¥ æ—¶æ¥ä¸Šä¸‹çš†åŒåŠ›ï¼Œè¿å»è‹±é›„ä¸è‡ªç”±ï¼"
        fi
        